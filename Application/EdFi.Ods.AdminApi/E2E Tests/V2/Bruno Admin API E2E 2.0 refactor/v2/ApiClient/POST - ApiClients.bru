meta {
  name: ApiClients
  type: http
  seq: 2
}

post {
  url: {{API_URL}}/v2/apiclients
  body: json
  auth: inherit
}

body:json {
  {
    "name": "Test ApiClient",
    "isApproved": true,
    "applicationId": {{CreatedApplicationId}},
    "odsInstanceIds": [
      {{ODSInstanceId}}
    ]
  }
}

script:pre-request {

  console.log("ðŸ”§ Setting pre environment to ignore SSL certificates...");
  
  // Safely set Node.js environment variable if available (CLI only)
  try {
    if (typeof process !== 'undefined' && process.env) {
      process.env.NODE_TLS_REJECT_UNAUTHORIZED = '0';
    }
  } catch (e) {
    // Ignore in UI environment
  }
  
  const axios = require('axios');
  const API_URL = bru.getEnvVar("API_URL");
  const TOKEN = bru.getEnvVar("TOKEN");

  // Generate unique identifiers to avoid conflicts
  const timestamp = Date.now();
  const uniqueId = Math.random().toString(36).substring(2, 8);

  // Configure axios to handle SSL and network issues
  const axiosConfig = {
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${TOKEN}`
    },
    validateStatus: function (status) {
      return status < 500;
    },
    timeout: 30000
  };

  // Add tenant header if multitenant mode is enabled
  if (bru.getEnvVar("isMultitenant") == "true") {
    axiosConfig.headers['Tenant'] = `${bru.getEnvVar("tenant1")}`;
  }

  try {
    // Create a vendor for the application test
    const vendorResponse = await axios.post(`${API_URL}/v2/vendors`, {
      "company": `Application Company ${timestamp}`,
      "namespacePrefixes": "uri://ed-fi.org",
      "contactName": `Application User ${uniqueId}`,
      "contactEmailAddress": `application-${uniqueId}@example.com`
    }, axiosConfig);

    if (vendorResponse.status === 201 && vendorResponse.headers && vendorResponse.headers.location) {
      const vendorId = vendorResponse.headers.location.split("/").pop();
      bru.setVar("ApplicationVendorId", vendorId);
      console.log("âœ… Vendor created successfully with ID:", vendorId);
    } else {
      console.log("âŒ Failed to create vendor:");
      console.log("Status:", vendorResponse.status);
      console.log("Response data:", JSON.stringify(vendorResponse.data, null, 2));
      throw new Error(`Failed to create vendor - Status: ${vendorResponse.status}, Data: ${JSON.stringify(vendorResponse.data)}`);
    }

    // Get first ODS instance
    const odsResponse = await axios.get(`${API_URL}/v2/odsInstances?offset=0&limit=1`, axiosConfig);

    if (odsResponse.status === 200 && odsResponse.data && odsResponse.data.length > 0 && odsResponse.data[0].id) {
      bru.setVar("ODSInstanceId", odsResponse.data[0].id);
      console.log("âœ… ODS Instance found with ID:", odsResponse.data[0].id);
    } else {
      console.log("âŒ Failed to get ODS instance:");
      console.log("Status:", odsResponse.status);
      console.log("Response data:", JSON.stringify(odsResponse.data, null, 2));
      throw new Error(`Failed to get ODS instance - Status: ${odsResponse.status}, Data: ${JSON.stringify(odsResponse.data)}`);
    }

    // Create application
    const applicationResponse = await axios.post(`${API_URL}/v2/applications`, {
      "applicationName": `Test Application ${uniqueId}`,
      "vendorId": bru.getVar("ApplicationVendorId"),
      "claimSetName": "Ed-Fi Sandbox",
      "profileIds": [],
      "educationOrganizationIds": [255901],
      "odsInstanceIds": [bru.getVar("ODSInstanceId")],
      "enabled": true
    }, axiosConfig);

    if (applicationResponse.status === 201 && applicationResponse.headers && applicationResponse.headers.location) {
      const applicationId = applicationResponse.headers.location.split("/").pop();
      bru.setVar("CreatedApplicationId", applicationId);
      console.log("âœ… Application created successfully with ID:", applicationId);
    } else {
      console.log("âŒ Failed to create application:");
      console.log("Status:", applicationResponse.status);
      console.log("Response data:", JSON.stringify(applicationResponse.data, null, 2));
      throw new Error(`Failed to create application - Status: ${applicationResponse.status}, Data: ${JSON.stringify(applicationResponse.data)}`);
    }
    
  } catch (error) {
    console.log("Error in pre-request setup:", error.message);
  }
}

script:post-response {
  test("POST ApiClients: Status code is Created", function () {
      expect(res.getStatus()).to.equal(201);
  });
  
  const result = res.getBody();
  
  test("POST ApiClients: Response includes location in header", function () {
      expect(res.getHeaders()).to.have.property("location");
  });
  
  test("POST ApiClients: Response result includes api client key and secret", function () {
      expect(result).to.have.property("id");
      expect(result).to.have.property("key");
      expect(result).to.have.property("secret");
      expect(result).to.have.property("applicationId");
  });
  
  if(result.id) {
      bru.setVar("CreatedApiClientId", result.id);
  }
  
  const response = res.getBody();
  const Ajv = require('ajv');
  const ajv = new Ajv();
  const PostApiClientSchema = {
    "type": "object",
    "properties": {
      "id": {
        "type": "integer"
      },
      "key": {
        "type": "string"
      },
      "secret": {
        "type": "string"
      },
      "applicationId": {
        "type": "integer"
      }
    },
    "required": [
      "id",
      "key",
      "secret",
      "applicationId"
    ]
  }
  
  test("POST ApiClient: Validation Schema Response", () => {
      const valid = ajv.validate(PostApiClientSchema, response);
      expect(valid).to.be.true;
      
      if (!valid) {
          console.log("Schema validation errors:", ajv.errors);
      }
  });
  
}

settings {
  encodeUrl: true
}
