meta {
  name: Profiles Duplicate Name
  type: http
  seq: 14
}

put {
  url: {{API_URL}}/v2/profiles/{{OtherCreatedProfileId}}
  body: json
  auth: inherit
}

body:json {
  {
      "Name": "Bruno-Test-Profile",
      "Definition": "<Profile name=\"Bruno-Test-Profile\"><Resource name=\"School\"><ReadContentType memberSelection=\"IncludeOnly\"><Collection name=\"EducationOrganizationAddresses\" memberSelection=\"IncludeOnly\"><Property name=\"City\" /><Property name=\"StateAbbreviationType\" /><Property name=\"PostalCode\" /></Collection></ReadContentType><WriteContentType memberSelection=\"IncludeOnly\"><Collection name=\"EducationOrganizationAddresses\" memberSelection=\"IncludeOnly\"><Property name=\"Latitude\" /><Property name=\"Longitude\" /></Collection></WriteContentType></Resource></Profile>"
  }
}

script:pre-request {
  console.log("üîß Setting pre environment to ignore SSL certificates...");
  // Safely set Node.js environment variable if available (CLI only)
  try {
    if (typeof process !== 'undefined' && process.env) {
      process.env.NODE_TLS_REJECT_UNAUTHORIZED = '0';
    }
  } catch (e) {
    // Ignore in UI environment
  }
  
  const axios = require('axios');
  const API_URL = bru.getEnvVar("API_URL");
  const TOKEN = bru.getEnvVar("TOKEN");

  // Configure axios to handle SSL and network issues
  const axiosConfig = {
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${TOKEN}`
    },
    validateStatus: function (status) {
      return status < 500;
    },
    timeout: 30000
  };

  // Add tenant header if multitenant mode is enabled
  if (bru.getEnvVar("isMultitenant") == "true") {
    axiosConfig.headers['Tenant'] = `${bru.getEnvVar("tenant1")}`;
  }

  try {
    const profileResponse = await axios.post(`${API_URL}/v2/profiles`, {
        "Name": `Other-Test-Profile`,
        "Definition": "<Profile name=\"Other-Test-Profile\"><Resource name=\"School\"><ReadContentType memberSelection=\"IncludeOnly\"><Collection name=\"EducationOrganizationAddresses\" memberSelection=\"IncludeOnly\"><Property name=\"City\" /><Property name=\"StateAbbreviationType\" /><Property name=\"PostalCode\" /></Collection></ReadContentType><WriteContentType memberSelection=\"IncludeOnly\"><Collection name=\"EducationOrganizationAddresses\" memberSelection=\"IncludeOnly\"><Property name=\"Latitude\" /><Property name=\"Longitude\" /></Collection></WriteContentType></Resource></Profile>"
    }, axiosConfig);

    if (profileResponse.status === 201) {
      console.log("‚úÖ Profile created successfully");
      let headers = profileResponse.headers; 
      expect(headers).to.have.property("location");
      const locationHeader = headers.location || headers["location"];
    if(locationHeader) {
          const locationStr = Array.isArray(locationHeader) ? locationHeader[0] : locationHeader;
          const id = locationStr.split("/").pop();
          if(id) {
              bru.setVar("OtherCreatedProfileId", id);
          }
      }
    } else {
      console.log("‚ùå Failed to create profile");
      console.log("Status:", profileResponse.status);
      console.log("Response data:", JSON.stringify(profileResponse.data, null, 2));
      throw new Error(`Failed to create profile - Status: ${profileResponse.status}, Data: ${JSON.stringify(profileResponse.data)}`);
    }    
  } catch (error) {
    console.log("Error in pre-request setup:", error.message);
  }  
}

script:post-response {
  test("PUT Profiles: Status code is Bad Request", function () {
      expect(res.getStatus()).to.equal(400);
  });
  
  const response = res.getBody();
  
  test("POST Profiles Invalid: Response matches error format", function () {
      expect(response).to.have.property("title");
      expect(response).to.have.property("errors");
  });
  
  test("POST Profiles Invalid: Response title is helpful and accurate", function () {
      expect(response.title.toLowerCase()).to.contain("validation");
  });
  
  test("POST Profiles Invalid: Response errors include messages by property", function () {
      expect(response.errors["Name"].length).to.equal(1);
  });
  
  test("POST Profiles Invalid: Response errors include messages with wrong element name", function () {
      expect(response.errors["Name"][0].toLowerCase()).to.contain("another profile with this name already exists in the database. please enter a unique name.");
  });
  
  console.log("üîß Setting post environment to ignore SSL certificates...");
  // Safely set Node.js environment variable if available (CLI only)
  try {
    if (typeof process !== 'undefined' && process.env) {
      process.env.NODE_TLS_REJECT_UNAUTHORIZED = '0';
    }
  } catch (e) {
    // Ignore in UI environment
  }
  
  const axios = require('axios');
  const API_URL = bru.getEnvVar("API_URL");
  const TOKEN = bru.getEnvVar("TOKEN");

  // Configure axios to handle SSL and network issues
  const axiosConfig = {
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${TOKEN}`
    },
    validateStatus: function (status) {
      return status < 500;
    },
    timeout: 30000
  };

  // Add tenant header if multitenant mode is enabled
  if (bru.getEnvVar("isMultitenant") == "true") {
    axiosConfig.headers['Tenant'] = `${bru.getEnvVar("tenant1")}`;
  }

  try {
    const profileCreated = bru.getVar("OtherCreatedProfileId")
    const profileResponse = await axios.delete(`${API_URL}/v2/profiles/${profileCreated}`, axiosConfig);

    if (profileResponse.status === 200) {
      console.log("‚úÖ Profile deleted successfully");
    } else {
      console.log("‚ùå Failed to delete profile");
      console.log("Status:", profileResponse.status);
      console.log("Response data:", JSON.stringify(profileResponse.data, null, 2));
      throw new Error(`Failed to delete profile - Status: ${profileResponse.status}, Data: ${JSON.stringify(profileResponse.data)}`);
    }    
  } catch (error) {
    console.log("Error in post-request setup:", error.message);
  }    
}

settings {
  encodeUrl: true
}
