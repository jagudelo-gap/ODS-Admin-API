meta {
  name: Admin API E2E 2.0 - Sorting and Filtering - Application
  seq: 29
}

auth {
  mode: bearer
}

auth:bearer {
  token: {{TOKEN}}
}

script:pre-request {
  console.log("ðŸ”§ Setting pre environment to ignore SSL certificates...");
  
  // Safely set Node.js environment variable if available (CLI only)
  try {
    if (typeof process !== 'undefined' && process.env) {
      process.env.NODE_TLS_REJECT_UNAUTHORIZED = '0';
    }
  } catch (e) {
    // Ignore in UI environment
  }
  
  const axios = require('axios');
  const API_URL = bru.getEnvVar("API_URL");
  const TOKEN = bru.getEnvVar("TOKEN");

  // Configure axios to handle SSL and network issues
  const axiosConfig = {
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${TOKEN}`
    },
    validateStatus: function (status) {
      return status < 500;
    },
    timeout: 30000
  };

  // Add tenant header if multitenant mode is enabled
  if (bru.getEnvVar("isMultitenant") == "true") {
    axiosConfig.headers['Tenant'] = `${bru.getEnvVar("tenant1")}`;
  }

  try {
    let totalToCreate = bru.getEnvVar("APPLICATIONCOUNT");
    var claimsetsToDelete = [];
    var vendorsToDelete = [];
    var odsintancesToDelete = [];
    var applicationsToDelete = [];

    for (let i = 0; i < totalToCreate; i++) {

        const timestamp = Date.now();
        const uniqueId = Math.random().toString(36).substring(2, 8);

        let applicationName =  timestamp;
        let claimsetName =  timestamp;
        var vendorId = 0;
        var odsInstanceId = 0;
        bru.setEnvVar("FILTERAPPLICATIONNAME", applicationName);
        bru.setEnvVar("FILTERCLAIMSETNAME", claimsetName);

        const schemaResponse = await axios.post(`${API_URL}/v2/claimSets`, {
          "name": `ClaimSet Pre ${uniqueId}`
        }, axiosConfig);

        if (schemaResponse.status === 201) {
          console.log(`âœ… Schema ${i} created successfully`);
          let location = schemaResponse.headers.get('Location');
          let matches = location.match(/(\d+)/);
          id = parseInt(matches[0], 10);
          claimsetsToDelete.push(id)

        } else {
          console.log(`âŒ Failed to create schema ${i}`);
          console.log("Status:", schemaResponse.status);
          console.log("Response data:", JSON.stringify(schemaResponse.data, null, 2));
          throw new Error(`Failed to create schema - Status: ${schemaResponse.status}, Data: ${JSON.stringify(schemaResponse.data)}`);
        }

        const vendorResponse = await axios.post(`${API_URL}/v2/vendors`, {
          "company": `Company ${timestamp}`,
          "namespacePrefixes": `uri://${timestamp}.org`,
          "contactName": `Application ${timestamp}`,
          "contactEmailAddress": `${timestamp}@example.com`
        }, axiosConfig);

        if (vendorResponse.status === 201) {
          console.log(`âœ… Vendor ${i} created successfully`);
          let location = vendorResponse.headers.get('Location');
          let matches = location.match(/(\d+)/);
          id = parseInt(matches[0], 10);
          vendorId = id;
          vendorsToDelete.push(id)
        } else {
          console.log(`âŒ Failed to create vendor ${i}`);
          console.log("Status:", vendorResponse.status);
          console.log("Response data:", JSON.stringify(vendorResponse.data, null, 2));
          throw new Error(`Failed to create vendor - Status: ${vendorResponse.status}, Data: ${JSON.stringify(vendorResponse.data)}`);
        }

        const odsResponse = await axios.post(`${API_URL}/v2/odsInstances`, {
             "name": `Ods Instance ${timestamp}`, 
             "instanceType": 'postgresql', 
             "connectionString": bru.getEnvVar("connectionString")
        }, axiosConfig);

        if (odsResponse.status === 201) {
          console.log(`âœ… OdsInstance ${i} Created Successfully`);
          let location = odsResponse.headers.get('Location');
          let matches = location.match(/(\d+)/);
          id = parseInt(matches[0], 10);
          odsInstanceId = id;
          odsintancesToDelete.push(id)
        } else {
          console.log(`âŒ Failed to post odsInstances ${i}`);
          console.log("Status:", odsResponse.status);
          console.log("Response data:", JSON.stringify(odsResponse.data, null, 2));
          throw new Error(`Failed to post odsInstances - Status: ${odsResponse.status}, Data: ${JSON.stringify(odsResponse.data)}`);
        } 

        const applicationResponse = await axios.post(`${API_URL}/v2/applications`, {
            "applicationName": `${applicationName}`,
            "vendorId": vendorId,
            "claimSetName": `${claimsetName}`,
            "profileIds": [],
            "educationOrganizationIds": [100],
            "odsInstanceIds": [ odsInstanceId ],
            "enabled" : true
        }, axiosConfig);
    
        if (applicationResponse.status === 201) {
          console.log(`âœ… Application ${i} created successfully`);
          let location = applicationResponse.headers.get('location');
          let matches = location.match(/(\d+)/);
          let id = parseInt(matches[0], 10);
          applicationsToDelete.push(id)
        } else {
          console.log(`âŒ Failed to create application ${i}`);
          console.log("Status:", applicationResponse.status);
          console.log("Response data:", JSON.stringify(applicationResponse.data, null, 2));
          throw new Error(`Failed to create application - Status: ${applicationResponse.status}, Data: ${JSON.stringify(applicationResponse.data)}`);
        }

    }

    bru.setEnvVar("VENDORTODELETE", vendorsToDelete);
    bru.setEnvVar("CLAIMSETSTODELETE", claimsetsToDelete);
    bru.setEnvVar("ODSINSTANCETODELETE", odsintancesToDelete);
    bru.setEnvVar("APPLICATIONSTODELETE", applicationsToDelete);

  } catch (error) {
    console.log("Error in pre-request setup:", error.message);
  }

}

script:post-response {
  (async () => {
    console.log("ðŸ”§ Setting post environment to ignore SSL certificates...");
  
    // Safely set Node.js environment variable if available (CLI only)
    try {
      if (typeof process !== 'undefined' && process.env) {
        process.env.NODE_TLS_REJECT_UNAUTHORIZED = '0';
      }
    } catch (e) {
      // Ignore in UI environment
    }
  
  const axios = require('axios');
  const API_URL = bru.getEnvVar("API_URL");
  const TOKEN = bru.getEnvVar("TOKEN");

  // Configure axios to handle SSL and network issues
  const axiosConfig = {
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${TOKEN}`
    },
    validateStatus: function (status) {
      return status < 500;
    },
    timeout: 30000
  };

  // Add tenant header if multitenant mode is enabled
  if (bru.getEnvVar("isMultitenant") == "true") {
    axiosConfig.headers['Tenant'] = `${bru.getEnvVar("tenant1")}`;
  }

  try {

    async function deleteClaimsetById(id) {
        const schemaResponse = await axios.delete(`${API_URL}/v2/claimSets/${id}`, axiosConfig);

        if (schemaResponse.status === 200) {
          console.log(`âœ… Schema ${id} deleted successfully`);
        } else {
          console.log(`âŒ Failed to delete schema ${id}`);
          console.log("Status:", schemaResponse.status);
          console.log("Response data:", JSON.stringify(schemaResponse.data, null, 2));
          throw new Error(`Failed to delete schema - Status: ${schemaResponse.status}, Data: ${JSON.stringify(schemaResponse.data)}`);
        }
    }

    async function deleteODSInstanceById(id) {
        const odsResponse = await axios.delete(`${API_URL}/v2/odsInstances/${id}`, axiosConfig);

        if (odsResponse.status === 200) {
          console.log(`âœ… OdsInstance ${id} deleted successfully`);
        } else {
          console.log("âŒ Failed to delete odsinstance");
          console.log("Status:", odsResponse.status);
          console.log("Response data:", JSON.stringify(odsResponse.data, null, 2));
          throw new Error(`Failed to delete odsinstance - Status: ${odsResponse.status}, Data: ${JSON.stringify(odsResponse.data)}`);
        }
    }

    async function deleteVendorById(id) {
        const schemaResponse = await axios.delete(`${API_URL}/v2/vendors/${id}`, axiosConfig);

        if (schemaResponse.status === 200) {
          console.log(`âœ… Vendor ${id} deleted successfully`);
        } else {
          console.log(`âŒ Failed to delete vendor ${id}`);
          console.log("Status:", schemaResponse.status);
          console.log("Response data:", JSON.stringify(schemaResponse.data, null, 2));
          throw new Error(`Failed to delete vendor - Status: ${schemaResponse.status}, Data: ${JSON.stringify(schemaResponse.data)}`);
        }
    }

    let vendorToDelete = bru.getEnvVar("VENDORTODELETE") || [];
    for (let j = 0; j < vendorToDelete.length; j++) {
        await deleteVendorById(vendorToDelete[j]);
    }

    let claimsetsToDelete = bru.getEnvVar("CLAIMSETSTODELETE") || [];
    for (let k = 0; k < claimsetsToDelete.length; k++) {
        await deleteClaimsetById(claimsetsToDelete[k]);
    }

    let odsInstanceToDelete = bru.getEnvVar("ODSINSTANCETODELETE") || [];
    for (let l = 0; l < odsInstanceToDelete.length; l++) {
        await deleteODSInstanceById(odsInstanceToDelete[l]);
    }

  } catch (error) {
    console.log("Error in post-request setup:", error.message);
  }
  })();
}
