meta {
  name: offsetLimits
}

auth {
  mode: inherit
}

script:pre-request {
  console.log("ðŸ”§ Setting environment to ignore SSL certificates...");
  
  // Safely set Node.js environment variable if available (CLI only)
  try {
    if (typeof process !== 'undefined' && process.env) {
      process.env.NODE_TLS_REJECT_UNAUTHORIZED = '0';
    }
  } catch (e) {
    // Ignore in UI environment
  }
  
  const axios = require('axios');
  const API_URL = bru.getEnvVar("API_URL");
  const TOKEN = bru.getEnvVar("TOKEN");
  
    // Configure axios to handle SSL and network issues
  const axiosConfig = {
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${TOKEN}`
    },
    validateStatus: function (status) {
      return status < 500;
    },
    timeout: 30000
  };
  
  let totalToCreate = parseInt(bru.getEnvVar("VENDORSCOUNT"), 10);
  var vendorsToDelete = [];
  let vendorNamePrefix = 'My application company'
  for (let i = 0; i < totalToCreate; i++) {
      let company = `${vendorNamePrefix} ${i}`;
      let namespacePrefixes = 'uri://edfi.org';
      let contactName = 'Joe Doe';
      let contactEmailAddress = 'joedoe@test-ed-fi.org';
      
      try {
        // Create a vendor for the application test
        const vendorResponse = await axios.post(`${API_URL}/v1/vendors`, {
          "company": `${company}`,
          "namespacePrefixes": `${namespacePrefixes}`,
          "contactName": `${contactName}`,
          "contactEmailAddress": `${contactEmailAddress}`
        }, axiosConfig);
    
        if (vendorResponse.status === 201 && vendorResponse.data && vendorResponse.data.result && vendorResponse.data.result.vendorId) {
          console.log("âœ… Vendor created successfully with ID:", vendorResponse.data.result.vendorId);
          let location = vendorResponse.headers.location;
          let matches = location.match(/(\d+)/);
          let vendorId = parseInt(matches[0], 10);
          vendorsToDelete.push(vendorId);
        } else {
          console.log("âŒ Failed to create vendor:");
          console.log("Status:", vendorResponse.status);
          console.log("Response data:", JSON.stringify(vendorResponse.data, null, 2));
          throw new Error(`Failed to create vendor - Status: ${vendorResponse.status}, Data: ${JSON.stringify(vendorResponse.data)}`);
        }
        
      } catch (error) {
        console.log("Error in pre-request setup:", error.message);
      }
  
  }
  bru.setVar("VENDORSTODELETE", vendorsToDelete);
}

script:post-response {
console.log("ðŸ”§ Setting environment to ignore SSL certificates...");
  
  // Safely set Node.js environment variable if available (CLI only)
  try {
    if (typeof process !== 'undefined' && process.env) {
      process.env.NODE_TLS_REJECT_UNAUTHORIZED = '0';
    }
  } catch (e) {
    // Ignore in UI environment
  }
  
  const axios = require('axios');
  const API_URL = bru.getEnvVar("API_URL");
  const TOKEN = bru.getEnvVar("TOKEN");
  
    // Configure axios to handle SSL and network issues
  const axiosConfig = {
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${TOKEN}`
    },
    validateStatus: function (status) {
      return status < 500;
    },
    timeout: 30000
  };

  let vendorsToDelete = bru.getVar("VENDORSTODELETE");
  for (let i = 0; i < vendorsToDelete.length; i++) {
      let id = vendorsToDelete[i];
    try {
        // Create a vendor for the application test
        const vendorResponse = await axios.delete(`${API_URL}/v1/vendors/${id}`, axiosConfig);
    
        if (vendorResponse.status === 200) {
          console.log("âœ… Vendor delete successfully");
        } else {
          console.log("âŒ Failed to delete vendor:");
          console.log("Status:", vendorResponse.status);
          console.log("Response data:", JSON.stringify(vendorResponse.data, null, 2));
          throw new Error(`Failed to delete vendor - Status: ${vendorResponse.status}, Data: ${JSON.stringify(vendorResponse.data)}`);
        }
        
      } catch (error) {
        console.log("Error in post-request setup:", error.message);
      }
  }
}
