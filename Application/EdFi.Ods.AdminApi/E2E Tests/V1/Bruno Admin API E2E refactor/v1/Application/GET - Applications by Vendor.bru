meta {
  name: Applications by Vendor
  type: http
  seq: 9
}

get {
  url: {{API_URL}}/v1/vendors/{{ApplicationVendorId}}/applications
  body: none
  auth: inherit
}

vars:pre-request {
  ApplicationVendorId: 23
}

script:pre-request {
  console.log("ðŸ”§ Setting environment to ignore SSL certificates...");
  
  // Safely set Node.js environment variable if available (CLI only)
  try {
    if (typeof process !== 'undefined' && process.env) {
      process.env.NODE_TLS_REJECT_UNAUTHORIZED = '0';
    }
  } catch (e) {
    // Ignore in UI environment
  }
  
  const axios = require('axios');
  const API_URL = bru.getEnvVar("API_URL");
  const TOKEN = bru.getEnvVar("TOKEN");
  
  // Generate unique identifiers to avoid conflicts
  const timestamp = Date.now();
  const uniqueId = Math.random().toString(36).substring(2, 8);
  
  // Configure axios to handle SSL and network issues
  const axiosConfig = {
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${TOKEN}`
    },
    validateStatus: function (status) {
      return status < 500;
    },
    timeout: 30000
  };
  
  try {
    // Create a vendor for the application test
    const vendorResponse = await axios.post(`${API_URL}/v1/vendors`, {
      "company": `Other Company ${timestamp}`,
      "namespacePrefixes": "uri://ed-fi.org",
      "contactName": `Other Application User ${uniqueId}`,
      "contactEmailAddress": `otherapplication-${uniqueId}@example.com`
    }, axiosConfig);
  
    if (vendorResponse.status === 201 && vendorResponse.data && vendorResponse.data.result && vendorResponse.data.result.vendorId) {
      bru.setVar("OtherApplicationVendorId", vendorResponse.data.result.vendorId);
      console.log("âœ… Vendor created successfully with ID:", vendorResponse.data.result.vendorId);
    } else {
      console.log("âŒ Failed to create vendor:");
      console.log("Status:", vendorResponse.status);
      console.log("Response data:", JSON.stringify(vendorResponse.data, null, 2));
      throw new Error(`Failed to create vendor - Status: ${vendorResponse.status}, Data: ${JSON.stringify(vendorResponse.data)}`);
    }
  
    // Create an application for the test
    const applicationResponse = await axios.post(`${API_URL}/v1/applications`, {
      "applicationName": "Other Vendor Application",
      "vendorId": vendorResponse.data.result.vendorId,
      "odsInstanceId": bru.getVar("CreateOdsInstanceId"),
      "claimSetName": "Ed-Fi Sandbox",
      "profileId": null,
      "educationOrganizationIds": [ 255901 ]
    }, axiosConfig);
  
    if (applicationResponse.status === 201 && applicationResponse.data && applicationResponse.data.result && applicationResponse.data.result.applicationId) {
      bru.setVar("OtherApplicationId", applicationResponse.data.result.applicationId);
      console.log("âœ… Application created successfully with ID:", applicationResponse.data.result.applicationId);
    } else {
      console.log("âŒ Failed to create application:");
      console.log("Status:", applicationResponse.status);
      console.log("Response data:", JSON.stringify(applicationResponse.data, null, 2));
      throw new Error(`Failed to create application - Status: ${applicationResponse.status}, Data: ${JSON.stringify(applicationResponse.data)}`);
    }
    
  } catch (error) {
    console.log("Error in pre-request setup:", error.message);
  }  
}

script:post-response {
  test("Status code is OK", function () {
      expect(res.getStatus()).to.equal(200);
  });
  
  const response = res.getBody();
  const results = res.getBody().result;
  
  test("Response matches success format", function () {
      expect(response.status).to.equal(200);
      expect(response).to.have.property("title");
      expect(response).to.have.property("result");
  });
  
  test("Response result includes applications", function () {
      expect(results.length).to.be.greaterThan(0);
  
      const indexOfApplication = results.map(
          function(application) { return application.applicationId; }
      ).indexOf(bru.getVar("CreatedApplicationId"));
  
      const result = results[indexOfApplication];
      expect(result.applicationName).to.contains("Application");
      expect(result.claimSetName).to.equal("Ed-Fi Sandbox");
      expect(result.educationOrganizationIds).to.length(1);
      expect(result.educationOrganizationIds[0]).to.equal(255901);
      expect(result.profileName).to.equal(null);
      expect(result.odsInstanceName).to.contains("Test Ods Instance");
      expect(result.profiles).to.length(0);
      expect(result.vendorId).to.not.equal(null);
      expect(result.vendorId).to.greaterThan(0);
  });
  
  test("Response result is filtered by vendor", function () {
      const resultApplicationIds = results.map(
          function(application) { return application.applicationId; }
      );
  
      expect(resultApplicationIds).to.contain(bru.getVar("CreatedApplicationId"));
      expect(resultApplicationIds).to.not.contain(bru.getVar("OtherApplicationId"));
  });
  
  test("Response results do not include key or secret", function () {
      results.forEach(function(result, i) {
          expect(result).to.not.have.property("key");
          expect(result).to.not.have.property("secret");
      });
  });
  
}

settings {
  encodeUrl: true
  timeout: 0
}
