meta {
  name: offsetLimits
}

auth {
  mode: inherit
}

script:pre-request {
  console.log("ðŸ”§ Setting environment to ignore SSL certificates...");
  
  // Safely set Node.js environment variable if available (CLI only)
  try {
    if (typeof process !== 'undefined' && process.env) {
      process.env.NODE_TLS_REJECT_UNAUTHORIZED = '0';
    }
  } catch (e) {
    // Ignore in UI environment
  }
  
  const axios = require('axios');
  const API_URL = bru.getEnvVar("API_URL");
  const TOKEN = bru.getEnvVar("TOKEN");
  
  // Configure axios to handle SSL and network issues
  const axiosConfig = {
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${TOKEN}`
    },
    validateStatus: function (status) {
      return status < 500;
    },
    timeout: 30000
  };

  try {
    // Create a vendor for the application test
    const vendorResponse = await axios.post(`${API_URL}/v1/vendors`, {
      "company": "My Application Company",
      "namespacePrefixes": "uri://ed-fi.org",
      "contactName": "Application User",
      "contactEmailAddress": "application@example.com"
    }, axiosConfig);

    if (vendorResponse.status === 201 && vendorResponse.data && vendorResponse.data.result && vendorResponse.data.result.vendorId) {
      console.log("âœ… Ods created successfully with ID:", vendorResponse.data.result.vendorId);
      bru.setVar("MyApplicationVendorId", vendorResponse.data.result.vendorId);
      let totalToCreate = parseInt(bru.getEnvVar("APPLICATIONCOUNT"), 10);
      var applicationsToDelete = [];
      let applicationNamePrefix = 'My application'
      for (let i = 0; i < totalToCreate; i++) {
          let applicationName = `${applicationNamePrefix} ${i}`;
          let vendorId = vendorResponse.data.result.vendorId;

          // Create an application for the test
          const applicationResponse = await axios.post(`${API_URL}/v1/applications`, {
            "applicationName": `${applicationName}`,
            "vendorId": vendorId,
            "claimSetName": "Ed-Fi Sandbox",
            "profileId": null,
            "educationOrganizationIds": [ 255901 ]
          }, axiosConfig);
        
          if (applicationResponse.status === 201 && applicationResponse.data && applicationResponse.data.result && applicationResponse.data.result.applicationId) {
            bru.setVar("OtherApplicationId", applicationResponse.data.result.applicationId);
            applicationsToDelete.push(applicationResponse.data.result.applicationId);
            console.log("âœ… Application created successfully with ID:", applicationResponse.data.result.applicationId);
          } else {
            console.log("âŒ Failed to create application:");
            console.log("Status:", applicationResponse.status);
            console.log("Response data:", JSON.stringify(applicationResponse.data, null, 2));
            throw new Error(`Failed to create application - Status: ${applicationResponse.status}, Data: ${JSON.stringify(applicationResponse.data)}`);
          }
      }
          bru.setVar("APPLICATIONSTODELETE", applicationsToDelete);

    } else {
      console.log("âŒ Failed to create vendor:");
      console.log("Status:", vendorResponse.status);
      console.log("Response data:", JSON.stringify(vendorResponse.data, null, 2));
      throw new Error(`Failed to create ods - Status: ${vendorResponse.status}, Data: ${JSON.stringify(vendorResponse.data)}`);
    }

  } catch (error) {
    console.log("Error in pre-request setup:", error.message);
  }
  
}

script:post-response {
console.log("ðŸ”§ Setting environment to ignore SSL certificates...");
  
  // Safely set Node.js environment variable if available (CLI only)
  try {
    if (typeof process !== 'undefined' && process.env) {
      process.env.NODE_TLS_REJECT_UNAUTHORIZED = '0';
    }
  } catch (e) {
    // Ignore in UI environment
  }
  
  const axios = require('axios');
  const API_URL = bru.getEnvVar("API_URL");
  const TOKEN = bru.getEnvVar("TOKEN");
  
    // Configure axios to handle SSL and network issues
  const axiosConfig = {
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${TOKEN}`
    },
    validateStatus: function (status) {
      return status < 500;
    },
    timeout: 30000
  };

  try {
    // Create a vendor for the application test
    const vendorResponse = await axios.delete(`${API_URL}/v1/vendors/${bru.getVar("MyApplicationVendorId")}`, axiosConfig);

    if (vendorResponse.status === 200) {
      console.log("âœ… Vendor delete successfully");
    } else {
      console.log("âŒ Failed to delete vendor:");
      console.log("Status:", vendorResponse.status);
      console.log("Response data:", JSON.stringify(vendorResponse.data, null, 2));
      throw new Error(`Failed to create vendor - Status: ${vendorResponse.status}, Data: ${JSON.stringify(vendorResponse.data)}`);
    }
    
  } catch (error) {
    console.log("Error in ppost-request setup:", error.message);
  }  
}
